name: Build Blog & Drafts
on:
  push:
    paths: ["drafts/**.md"]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with: { fetch-depth: 0 }

    - name: Install pandoc
      run: sudo apt-get update && sudo apt-get install -y pandoc

    - name: Generate posts
      run: |
        slug(){ echo "$1" | tr '[:upper:]' '[:lower:]' |
          sed -E 's/[√†√°√¢√£√§]/a/g;s/[√®√©√™√´]/e/g;s/[√¨√≠√Æ√Ø]/i/g;
                   s/[√≤√≥√¥√µ√∂]/o/g;s/[√π√∫√ª√º]/u/g;
                   s/[^a-z0-9]+/-/g;s/^-+|-+$//g'; }

        for md in drafts/*.md; do
          [ -e "$md" ] || continue
          title=$(head -1 "$md" | sed 's/^# //')
          slug=$(slug "$title")
          date=$(date +%F)
          html="blog/${date}-${slug}.html"
          body=$(pandoc "$md" -t html)

          sed -e "s/<!-- {{TITLE}} -->/${title}/" \
              -e "s|<!-- {{CONTENT}} -->|${body//|/\\|}|" \
              partials/template-post.html > "$html"

          card="<div class=\"card\">
                   <a href=\"${date}-${slug}.html\">
                     <div class=\"card-title\">${title}</div>
                   </a>
                 </div>"
          sed -i "/<!-- posts -->/a ${card}" blog/index.html

          grep -q "${date}-${slug}.html" sitemap.xml || \
            sed -i "$ i\\  <url><loc>https://consultoria.leonardograciano.com.br/blog/${date}-${slug}.html</loc></url>" sitemap.xml

          git mv "$md" "drafts/_done_${date}_${slug}.md"
        done

        git config user.name "blog-bot"
        git config user.email "bot@users.noreply.github.com"
        git add blog/ drafts/ blog/index.html sitemap.xml
        git commit -m "üìù novo post autom√°tico" || echo "nothing to commit"
        git push
